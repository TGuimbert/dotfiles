# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This is a NixOS dotfiles repository using Nix flakes. It manages configurations for multiple hosts (desktop and server systems) using a modular architecture with Home Manager integration. The repository implements an impermanence-based filesystem layout where `/` and `/home` are wiped on reboot for enhanced security.

## Common Commands

### Building and Switching Configurations

**Preferred: Use `nh` (NixOS Helper)**

```bash
# Build and activate configuration (automatically uses /home/tguimbert/.dotfiles)
nh os switch

# Test configuration without setting it as boot default
nh os test

# Just build without activating
nh os build
```

**Alternative: Direct nixos-rebuild commands**

```bash
# Build and activate for current host
sudo nixos-rebuild switch --flake .

# Build and activate for a specific host
sudo nixos-rebuild switch --flake .#<hostname>

# Test configuration without setting it as boot default
sudo nixos-rebuild test --flake .
```

### Updating the System

The repository uses CI (Renovate) to automatically update flake inputs. To update your system:

```bash
# Navigate to the dotfiles directory
cd ~/.dotfiles

# Pull the latest changes (flake.lock is updated by CI)
git pull

# Rebuild and switch to the new configuration
nh os switch
```

**Note**: You typically don't need to run `nix flake update` manually since flake updates are managed by CI.

### Formatting and Linting

```bash
# Format all Nix files
nix fmt

# Check for linter issues (uses statix)
statix check

# Auto-fix linter issues
statix fix
```

### Development Shells

The repository provides several development shells in `shells/`:

```bash
# Enter a development shell
nix develop .#<shell-name>

# Available shells:
nix develop .#nixos      # NixOS development tools
nix develop .#python     # Python (uses unstable)
nix develop .#rust       # Rust development
nix develop .#go         # Go development
nix develop .#ops        # Operations/DevOps tools
nix develop .#markdown   # Markdown tooling
nix develop .#nodejs     # Node.js development
nix develop .#protobuf   # Protocol Buffers

# Combined shells:
nix develop .#python-nodejs   # Python + Node.js
nix develop .#python-protobuf # Python + Protobuf
```

### Secrets Management (SOPS)

The repository uses SOPS for managing secrets with age encryption:

```bash
# Edit a secret file (auto-decrypts/encrypts)
sops secrets/common.yaml
sops secrets/srv-01.yaml

# Update all secrets after key rotation
find secrets -name "*.yaml" -exec sops updatekeys {} \;
```

Secret files are configured in `.sops.yaml` with per-host age keys.

### Initial Installation (New Host)

Follow the README.md installation instructions. Key steps:

1. Format disk with disko: `sudo nix run github:nix-community/disko -- --mode disko ./hosts/<hostname>/disks.nix`
2. Create user password: `sudo mkpasswd -s > /mnt/persistent/tguimbert-password`
3. Install: `sudo nixos-install --no-root-password --flake ./#<hostname>`
4. After reboot, setup secure boot with lanzaboote

## Architecture

### Flake Structure

- **`flake.nix`**: Main entry point defining outputs (nixosConfigurations, devShells, formatter)
- **Two configuration builders**:
  - `mkSystem`: For desktop systems (leshen, griffin, tuxedo) - includes lanzaboote, stylix, Home Manager
  - `mkServer`: For servers (srv-01) - minimal setup without desktop features

### Host Configurations

Located in `hosts/<hostname>/`:
- `default.nix`: Host-specific configuration (optional, servers only)
- `disks.nix`: Disko disk partitioning and BTRFS subvolume layout
- `hardware.nix`: Hardware-specific settings (generated by nixos-generate-config)
- Service-specific configs (e.g., `traefik.nix`, `authelia.nix` for srv-01)

**Current hosts**:
- `leshen`: Desktop system with GNOME, games, podman
- `griffin`: Lenovo ThinkPad T490 laptop with GNOME, games, podman
- `tuxedo`: Tuxedo InfinityBook laptop with GNOME, Docker, work config
- `srv-01`: Headless server with Traefik, LLDAP, Authelia, Homepage, Restic

### Module Organization

**NixOS modules** (`modules/nixos/`):
- `core.nix`: Base system config (boot, locale, user, networking, audio, services)
- `impermanence.nix`: BTRFS rollback script and persistence configuration
- `gnome.nix`: GNOME desktop environment
- `games.nix`: Gaming-related packages and configuration
- `docker.nix`: Docker setup
- `podman.nix`: Podman setup

**Home Manager modules** (`home/`):
- `default.nix`: Main user config with packages and persistence
- `shell.nix`: Shell configuration (nushell, helix, zellij, starship)
- `dev.nix`: Development tools and configurations
- `desktop.nix`: Desktop applications and GNOME settings
- `work.nix`: Work-specific overrides (imported only for tuxedo host)

### Impermanence Strategy

**BTRFS subvolumes** (defined in `hosts/*/disks.nix`):
- `/root`: Ephemeral, rolled back on boot
- `/nix`: Persistent (Nix store)
- `/persistent`: Persistent data
- `/var/log` (`/log`): Persistent logs
- `/home`: Ephemeral, rolled back on boot
- `/.snapshot`: Stores pre-rollback snapshots (15 days for root, 30 for home)
- `/.swapvol` (`/swap`): Swap file

**Rollback mechanism**: Implemented in `modules/nixos/impermanence.nix` via systemd initrd service that moves old root/home to snapshots and creates fresh subvolumes.

**Persistence**: Managed using the impermanence module with `environment.persistence."/persistent"` and `home.persistence."/persistent"` blocks throughout configs.

### Overlays

`overlays/default.nix`: Pulls specific packages from unstable channel (helix, k9s, obsidian, orca-slicer, nushell, etc.)

### Key Dependencies

Major flake inputs:
- `nixpkgs`: NixOS 25.11 stable
- `unstable`: nixos-unstable for bleeding-edge packages
- `home-manager`: User environment management
- `disko`: Declarative disk partitioning
- `impermanence`: Stateless system configuration
- `lanzaboote`: Secure Boot support
- `sops-nix`: Secret management
- `stylix`: System-wide theming
- `nixos-hardware`: Hardware-specific configurations
- `tuxedo-nixos`: Tuxedo laptop support

## Development Workflow

### Adding a New Package

For system packages, add to `modules/nixos/core.nix` or host-specific config.
For user packages, add to `home/default.nix` or relevant home module.
For unstable packages, add to `overlays/default.nix` first.

### Adding a New Host

1. Create `hosts/<hostname>/` directory
2. Add `disks.nix` (copy and modify from existing host)
3. Add `hardware.nix` (generate with `nixos-generate-config`)
4. Create age key for SOPS: `ssh-keyscan <hostname> | ssh-to-age`
5. Add host to `.sops.yaml`
6. Add host configuration to `flake.nix` using `mkSystem` or `mkServer`
7. Add secrets file if needed: `secrets/<hostname>.yaml`

### Modifying Persistence

To persist new directories/files, add them to:
- System-level: `environment.persistence."/persistent"` in host or module config
- User-level: `home.persistence."/persistent"` in home modules

Remember: Only explicitly listed paths persist across reboots.

## Editor Configuration

The default editor is Helix (`hx`), configured in `home/shell.nix` with:
- Auto-formatting for Nix (nixfmt), Markdown (dprint), Go (goimports), YAML (prettier), Python (ruff)
- LSP support for various languages
- YAML schemas for GitHub Actions, Ansible, Kubernetes

## Shell Environment

- **Shell**: Nushell (nu) with carapace completions
- **Multiplexer**: Zellij with custom keybindings
- **Terminal**: Foot (launches zellij on start)
- **Prompt**: Starship with custom gruvbox-rainbow theme

## Important Notes

- User is `tguimbert` with UID 1000, immutable users (`mutableUsers = false`)
- Password stored at `/persistent/tguimbert-password` (hashed)
- SSH keys are yubikey-based (`sk-ssh-ed25519`)
- Secure Boot enabled via lanzaboote (PKI bundle in `/etc/secureboot`)
- All desktop hosts use LUKS encryption with systemd-cryptenroll support (FIDO2/password/recovery)
- Network shares auto-mount from `//nas.lan/` via CIFS with SOPS credentials
- Tailscale enabled on desktop systems for remote access
